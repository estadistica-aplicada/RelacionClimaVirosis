---
title: "Relación clima-virosis en cultivos"
subtitle: "Desde el Aprendizaje Automático a la Modelación Estadística"
author: "Prof. Mónica Balzarini"
institute: "Maestría en estadística aplicada </br> Universidad Nacional de Córdoba"
format: 
    revealjs:
      echo: false
      cache: false
      auto-stretch: true
      center: true
      theme: style/theme.scss
      multiplex: true
      title-slide-attributes:
          data-background-image: img/logo25.png
          data-background-size: cover  
      revealjs-plugins:
         - plugins
---



# Relación clima-virosis en cultivos

## Desde el Aprendizaje Automático a la Modelación Estadística


:::: {.columns}

::: {.column width="50%"}

::: {style="text-align: center"}

Prof. Mónica Balzarini

:::

Maestría en Estadística Aplicada

Universidad Nacional de Córdoba


:::

::: {.column width="50%"}

![](img/ufyma.png)

:::

::::

![MEA](img/logo25.png)




# ¿Aprendizaje Automático es Estadística?


:::: {.columns}

::: {.column width="50%"}

**Estadística** 

Disciplina científica que aborda la variabilidad, el pensamiento bajo 
incertidumbre y la generación de conocimientos desde los datos.  

Analiza el proceso aleatorio que genera los datos siguiendo leyes de probabilidad.

Modela variabilidad para inferir relaciones desde los datos y predecir valores futuros.

:::

::: {.column width="50%"}

**Aprendizaje automático**

Rama de la Inteligencia Artificial que permite que las máquinas aprendan a
identificar patrones en los datos para predecir valores futuros. 

Base en teoría del aprendizaje estadístico: datificar el entorno, separar patrón
de ruido, extraer conclusiones y predecir resultados.

:::

::::



:::{.callout-note appearance="simple"}

El AA, mayoritariamente, es estadística computacional con fines predictivos

:::


## ¿Qué es la Ciencia de Datos? (dramático crecimiento en popularidad)

"Ciencia de datos" se define como lo que hacen los "científicos de datos". 

Adquisición y manipulación de datos, 

Aplicación de técnicas de análisis de datos (núcleo: Estadística y AA)

Interpretación, comunicación y visualización de los resultados. 


::: {.callout-note icon=false}

## Perfil del científico de datos

Generador (hacker) de bases de datos, analista, comunicador y consejero confiable

:::


## ¿Por qué está de moda la Ciencia de Datos? 
 
Los avances tecnológicos permiten ganar capacidades estadístico-computacionales,
creativas y comunicacionales más rápidamente y esta disponibilidad de talentos 
coincide temporalmente con la transformación digital y la datificación.

Grandes volúmenes de datos almacenados a gran escala.

Sabermetría. Números vencen a la intuición.

Datos y códigos abiertos (utilizados, reutilizados y redistribuidos libremente)
hacen los análisis reproducibles y facilitan la adaptación del análisis a nuevos
datos.



## ¿Aprendizaje automático o modelación estadística? ¿cuál es mejor? 
El fin (exploratorio/inferencial/predictivo) así como el volumen y 
conceptualización de los datos (población/muestra) guían la elección de técnicas
de análisis.

Multiplicidad de técnicas de análisis de datos con resultados mayoritariamente
convergentes o complementarios y deben ser entendidos como elementos que operan
en conjunto.


#Ensamblando aprendizaje automático y modelación estadística 

# High Plains Wheat Mosaic Virus (HPWMoV) en cultivos de maíz y trigo en función del clima

```{r}

suppressPackageStartupMessages({
library(sf)
library(dplyr)
library(tmap) 
library(tidyr)
library(INLA)
library(inlabru)
library(ggplot2)
})
# source("src/spde-book-functions.R")
tmap_mode("view")

trigo_maiz <- st_read("data/trigo_maiz_26_09_22.gpkg",quiet = TRUE)
st_geometry(trigo_maiz) <- 'geometry' 
trigo_maiz$HPV <- as.factor(trigo_maiz$HPV)
  

hpv_maiz <- trigo_maiz |> 
  filter(Especie == "Maíz" & !is.na(HPV))
hpv_maiz <-
  hpv_maiz[!hpv_maiz$Provincia %in%
              c('Catamarca',
               'Santa Fe',
               'Tucumán',
               'Chaco',
               'Santiago del Estero',
               'San Luis','Jujuy'),]


hpv_trigo <- trigo_maiz |> 
  filter(Especie == "Trigo" & !is.na(HPV)) 

```


## Datos del virus

* Presencia/ausencia georreferenciados desde que el virus entró al país 

* Total de registros: 169 en maíz y 451 en trigo. Las observaciones no están 
alineadas (posicionadas en el mismo sitio)

```{r}
tm_shape(hpv_maiz) +
  tm_dots("HPV", 
          group = "HPV Maíz",
          title = "HPV en Maíz", 
          pal = "Dark2") +
  tm_shape(hpv_trigo) +
  tm_dots("HPV", 
          group = "HPV Trigo",
          title = "HPV en Trigo", 
          pal = "Set1")
```


## Datos del clima

Derivados de Imágenes Satelitales: variables meteorológicas extraídas desde 
el producto ERA5 en formato de valores mensuales.

 _ERA5 Land (datos mensuales): ECMWF/ERA5/MONTHLY_

:::: {.columns}

::: {.column width="50%"}

- Combina datos de modelos físicos con observaciones de todo el mundo en un 
conjunto de datos globalmente completo y consistente 
- Resolución: 11.13  km
- Disponibles desde 1981 hasta tres meses en tiempo real

:::

::: {.column width="50%"}

- Bandas disponibles: 50. Entre éstas:
    * Temperatura del aire a 2 m
    * Temperatura de la superficie de la tierra y de capas de 0 a 289 cm de profundidad
    * Temperatura punto de rocío
    * Total precipitaciones
    * Volumen de agua en la capa 1, 2, 3 y 4 del suelo 
    * Total evaporación
    
:::

::::

Descarga con: Google Earth Engine, python conectado a GEE, R conectado a python y GEE

Agregadas según momentos del ciclo de cultivo conformaron 117 variables 
biometeorológicas. Se obtuvieron valores mensuales para el periodo anual
(Agosto de un año a Agosto del año siguiente) que abarca los dos cultivos 
en los que se detecta el virus 


## Variabilidad espacio-temporal de la temperatura

```{r}
#| eval: false


tmap_mode('plot')

my_temperatur_pallete <-
  c("#1E5CB4", "#1E5CB4", "#1E5CB4", "#1D5DB4", "#1B63B9", "#186ABE",
"#176FC2", "#176FC2", "#176FC2", "#1474C6", "#1080CE", "#0C8BD6",
"#0B8FD9", "#0B8FD9", "#0B8FD9", "#0894DD", "#069BE2", "#04A2E7",
"#04A2E7", "#04A2E7", "#05A3E7", "#0CAAEB", "#14B1EF", "#19B6F2",
"#19B6F2", "#19B6F2", "#1DB7EB", "#27B9DF", "#30BCD3", "#33BDD0",
"#33BDD0", "#33BDD0", "#42C2CF", "#55C7CF", "#66CDCF", "#66CDCF",
"#66CDCF", "#6ACECD", "#7CD3C5", "#8ED8BD", "#9ADCB9", "#9ADCB9",
"#9ADCB9", "#A1DEAF", "#AFE19E", "#BDE58D", "#C1E689", "#C1E689",
"#C1E689", "#C4E674", "#C9E65F", "#CDE74B", "#CDE74B", "#CDE74B",
"#D0E746", "#DEEB36", "#ECEE26", "#F4F11D", "#F4F11D", "#F4F11D",
"#F6ED1F", "#FAE622", "#FEE026", "#FFDF27", "#FFDF27", "#FFDF27",
"#FED71C", "#FDCF11", "#FDC807", "#FDC807", "#FDC807", "#FCC307",
"#FBB40A", "#F9A60C", "#F99E0E", "#F99E0E", "#F99E0E", "#F8940F",
"#F78412", "#F67514", "#F67215", "#F67215", "#F67215", "#F46317",
"#F35419", "#F2471C", "#F2471C", "#F2471C", "#EF421D", "#E73320",
"#DF2524", "#DC1E26", "#DC1E26", "#DC1E26", "#CF1F27", "#BB2229",
"#A8252B", "#A5262C", "#A5262C", "#A5262C")

library(raster)
poly_arg <- sf::st_read("data/argentina.gpkg")

ene <- raster("data/temperature/Ene.tif")
feb <- raster("data/temperature/Feb.tif")
mar <- raster("data/temperature/Mar.tif")
abr <- raster("data/temperature/Abr.tif")
may <- raster("data/temperature/May.tif")
jun <- raster("data/temperature/Jun.tif")
jul <- raster("data/temperature/Jul.tif")
ago <- raster("data/temperature/Ago.tif")
sep <- raster("data/temperature/Sep.tif")
oct <- raster("data/temperature/Oct.tif")
nov <- raster("data/temperature/Nov.tif")
dic <- raster("data/temperature/Dic.tif")

temp <- stack(ene, feb, mar, abr,
              may, jun, jul, ago,
              sep, oct, nov, dic)

mitmap <-
  tm_basemap(leaflet::providers$Esri.WorldTopoMap) +
  tm_shape(temp) +
  tm_raster(title = "Temperatura (°C)",
            style = "cont",
            palette = my_temperatur_pallete
            ) +
  tm_shape(poly_arg) +
  tm_borders() +
  # tm_facets() +
  tm_facets(
    # as.layers = TRUE,
    # nrow = 1, ncol = 1
    ) +
  tm_legend(legend.outside = TRUE)



tmap_animation(mitmap, filename = 'img/animacion_Temp.gif')

```


![Promedio mensual de temperatura](img/animacion_Temp.gif){fig-align="center"}



## Selección de variables con Aprendizaje Automático

Importancia de las variables climáticas en cada patosistema con algoritmo 
boruta y la selección de variables stepwise forward.

### Resultados

Predicen presencia del virus en maíz las precipitaciones elevadas en el 
mes de enero y temperatura de punto de rocio alta en el mes de mayo.

Predicen presencia de virus en trigo las precipitaciones elevadas en enero 
y temperaturas bajas en junio.


## Modelación Estadística con Modelos Jerárquicos 

### Contexto:

- Respuestas pueden afectarse una a otra 
- Tamaños muestrales y sitios con observaciones no iguales

*Aproximación Estadística*: _Joint spatial Bayesian regression model_

----

::: {style="font-size: 0.7em"}

$$
\log{\left(\frac{p_{i.maíz}(S)}{1-p_{i.maiz}(S)}\right)} = 
\alpha_{maíz} + x_{i1}(S)\beta_{1.maíz} + x_{i2}(S)\beta_{2.maíz} + x_{i3}(S)\beta_{3.maíz} +
Z_{maíz}(S) + e_{maíz}(S)
$$

$$
\log{\left(\frac{p_{i.trigo}(S)}{1-p_{i.trigo}(S)}\right)} = 
\alpha_{trigo} + x_{i1}(S)\beta_{4.trigo} + x_{i5}(S)\beta_{5.trigo} + \lambda Z_{maíz}(S) +
Z_{trigo} (S) + e_{trigo} (S)
$$

:::

donde $\log{\left(\frac{p_ij}{1 - p_ij}\right)}$ es la función de enlace, $x_1$ 
es el total de precipitaciones del mes de enero, $x_2$ es la temperatura punto 
rocío del mes de mayo y $x_3$ es el año en el que se tomó la muestra, $x_4$ 
es la temperatura del mes de junio, $Z$ es el efecto espacial

$$Z.(S) \sim MVM(0, \Sigma)$$

$\Sigma^{-1}$ (matriz de precisión) modelada vía un MRF resuelto por SPDE 

Proyecciones de los efectos espaciales en una malla de predicción común.

A priori de coeficientes de regresión sugeridas por modelos marginales. 


## Ajsute del modelo

### Fórmula 

```{r}
#| echo: true
#| eval: false
form <- y ~ -1 +
  intercept_hpv_maiz +
  intercept_hpv_trigo +
  
  Precipitacion_Jan_maiz + 
  Punto.rocio_May_maiz + 
  anio_maiz + 
  
  Precipitacion_Jan_trigo + 
  Temperatura_Jun_trigo +
  
  f(s1, model = spde) + 
  f(s2, model = spde) + 
  f(s12, copy = "s1", fixed = FALSE)
```

```{r}
#| eval: false
#| 
inla.setOption(inla.mode = 'experimental')

trigo_hpv_sf2 <- st_read("data/trigo_hpv.gpkg", quiet = TRUE)
st_geometry(trigo_hpv_sf2) <- 'geometry'

limites2 <- st_read("data/limites2.gpkg", quiet = TRUE)
st_geometry(limites2) <- 'geometry'

base_maiz <- trigo_hpv_sf2 |>
  drop_na(HPV_maiz)

base_maiz <- base_maiz[!base_maiz$Provincia %in%
                         c('Catamarca',
                           'Santa Fe',
                           'Tucumán',
                           'Chaco',
                           'Santiago del Estero',
                           'San Luis',
                           'Jujuy'), ]

loc.maiz <- base_maiz |>
  st_coordinates()


base_trigo <- trigo_hpv_sf2 |>
  drop_na(HPV_trigo)

loc.trigo <- base_trigo |>
  st_coordinates()

loc.obs <-
  rbind(st_coordinates(base_trigo), st_coordinates(base_maiz))

boundary <- list(inla.nonconvex.hull(loc.obs, 2),
                 inla.nonconvex.hull(loc.obs, 4))

mesh <- inla.mesh.2d(
  boundary = boundary,
  max.edge = c(0.4, 0.8),
  min.angle = c(30, 21),
  max.n = c(480, 160),
  max.n.strict = c(128000, 128000),
  cutoff = 0.03,
  offset = c(2, 4)
)

spde <- inla.spde2.pcmatern(
  mesh = mesh,
  prior.range = c(1000, 0.01),
  # P(range < rangemin) = 0.01
  prior.sigma = c(10, 0.01)
)

Amaiz <- inla.spde.make.A(mesh, loc.maiz)

Atrigo <- inla.spde.make.A(mesh, loc.trigo)

stackMaiz <- inla.stack(
  data = list(y = cbind(NA, base_maiz$HPV_maiz)),
  A = list(Amaiz, 1),
  effects = list(
    list(s1 = 1:spde$n.spde),
    list(
      intercept_hpv_trigo = rep(1, nrow(base_maiz)),
      
      Precipitacion_Jan_maiz  = base_maiz$Precipitacion_Jan,
      Punto.rocio_May_maiz = base_maiz$Punto.rocio_May,
      anio_maiz = base_maiz$Año.de.Colecta,
      
      Precipitacion_Jan_trigo  = rep(NA, nrow(base_maiz)),
      Temperatura_Jun_trigo = rep(NA, nrow(base_maiz))
    )
    
  ),
  tag = "WSMV_maiz"
)


stackTrigo <- inla.stack(
  data = list(y = cbind(base_trigo$HPV_trigo, NA)),
  A = list(Atrigo, 1),
  effects = list(
    list(s2 = 1:spde$n.spde, s12 = 1:spde$n.spde),
    list(
      intercept_hpv_maiz = rep(1, nrow(base_trigo)),
      
      Precipitacion_Jan_maiz  = rep(NA, nrow(base_trigo)),
      Punto.rocio_May_maiz = rep(NA, nrow(base_trigo)),
      anio_maiz = rep(NA, nrow(base_trigo)),
      
      Precipitacion_Jan_trigo = base_trigo$Precipitacion_Jan,
      Temperatura_Jun_trigo = base_trigo$Temperatura_Jun
    )
  ),
  tag = "WSMV_trigo"
)


stack <- inla.stack(stackTrigo, stackMaiz)

set.seed(123)
result <- inla(
  form,
  rep('binomial', 2),
  data = inla.stack.data(stack),
  control.predictor = list(
    compute = TRUE,
    A = inla.stack.A(stack),
    link = 1
  ),
  
  control.compute = list(
    return.marginals = TRUE,
    return.marginals.predictor = TRUE,
    hyperpar = TRUE
  )
)

saveRDS(result,
        'results/inla_results.RDS')
```

---

### Resultados

```{r, results='asis'}
result <- readRDS('results/inla_results.RDS')

kableExtra::kable(
  result$summary.fixed[, -ncol(result$summary.fixed)],
  escape = FALSE,
  format = "html",
  digits = 3
) |>
 kableExtra::kable_paper("striped", full_width = F)


kableExtra::kable(
  result$summary.hyperpar,
  escape = FALSE,
  format = "html",
  digits = 3
) |>
 kableExtra::kable_paper("hover", full_width = F)

```



## Validación del modelo

Validación cruzada k-fold, con un k = 10, para cada cultivo.

Medidas del desempeño predictivo

```{r}

colnames_1 <- rep(c("Accuracy", "Sensibilidad", "Especificidad", "AUC"), 2)

Maíz <- c(#'Trigo',
          58.12,
          53.57,
          59.55,
          0.565,
          59.87,
          55.42,
          60.87,
          0.581)

Trigo <- c(#'Maíz',
          57.43,
          58.38,
          56.69,
          0.575,
          63.64,
          66.67,
          61.57,
          0.641)

df <- rbind(Maíz, Trigo)

kableExtra::kable(df,
                  escape = FALSE,
                  format = "html",
                  digits = 3) |>
  kableExtra::kable_paper("hover", full_width = F) |>
  kableExtra::add_header_above(c(" ", colnames_1))  |>
  kableExtra::add_header_above(c(" ", "Marginal" = 4, "Conjunta" = 4), align = "l")  |>
  kableExtra::add_header_above(c("HPWMoV" = 9)) |>
  kableExtra::kable_paper("striped", full_width = F)

```


# Comentarios Finales

- Los algoritmos de AA facilitaron la selección de variables con capacidad 
predictiva.
- La modelación conjunta permitió aumentar la capacidad predictiva de la 
presencia de virus en el cultivo de trigo en relación con el clima respecto a la 
obtenida en el modelo marginal con las mismas regresoras.
- El modelo estadístico provee un mecanismo para mapeo digital de ambos procesos
y su incertidumbre en cada sitio.
- La Estadística es Ciencia de Datos.
